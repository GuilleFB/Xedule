{% extends "base.html" %}

{% block content %}
  <div class="container">
    <h1>Mis Tweets</h1>
    <div class="mb-3 d-flex justify-content-between">
      <div>
        <a href="{% url 'tweet_create' %}" class="btn btn-primary">Nuevo Tweet</a>
      </div>
      <div>
        <button id="selectAllBtn" class="btn btn-outline-primary me-2">Seleccionar todos</button>
        <button id="deselectAllBtn" class="btn btn-outline-secondary">Deseleccionar todos</button>
      </div>
      <a href="{% url 'tweet_bulk_upload' %}" class="btn btn-success">
        <i class="bi bi-file-earmark-excel"></i> Carga Masiva
      </a>
    </div>
    {% if tweets %}
      <form method="post"
            action="{% url 'bulk_delete_tweets' %}"
            id="bulkDeleteForm">
        {% csrf_token %}
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th class="w-40">
                  <input type="checkbox" id="selectAll" />
                </th>
                <th>Contenido</th>
                <th>Estado</th>
                <th>Fecha programada</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for tweet in tweets %}
                <tr>
                  <td>
                    <input type="checkbox"
                           name="tweet_ids"
                           value="{{ tweet.id }}"
                           class="tweet-checkbox" />
                  </td>
                  <td>
                    <a href="{% url 'tweet_detail' tweet.id %}">{{ tweet.content|truncatechars:50 }}</a>
                  </td>
                  <td>
                    {% if tweet.status == 'pending' %}
                      <span class="badge bg-warning text-dark">Pendiente</span>
                    {% elif tweet.status == 'published' %}
                      <span class="badge bg-success">Publicado</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ tweet.get_status_display }}</span>
                    {% endif %}
                  </td>
                  <td>{{ tweet.scheduled_time|default:"N/A" }}</td>
                  <td>
                    <a href="{% url 'tweet_detail' tweet.id %}" class="btn btn-sm btn-info">Ver</a>
                    <a href="{% url 'tweet_update' tweet.id %}"
                       class="btn btn-sm btn-warning">Editar</a>
                    <a href="{% url 'tweet_delete' tweet.id %}"
                       class="btn btn-sm btn-danger">Eliminar</a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="mt-3">
          <button type="submit" class="btn btn-danger" id="bulkDeleteBtn" disabled>Eliminar seleccionados</button>
        </div>
      </form>
      {% include "./pagination.html" with page=page_obj %}
    {% else %}
      <div class="alert alert-info">No tienes tweets programados.</div>
    {% endif %}
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const selectAllCheckbox = document.getElementById('selectAll');
      const selectAllButton = document.getElementById('selectAllBtn');
      const deselectAllButton = document.getElementById('deselectAllBtn');
      const tweetCheckboxes = document.querySelectorAll('.tweet-checkbox');
      const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');

      // Función para actualizar el estado del botón de eliminar
      function updateDeleteButtonState() {
        const checkedBoxes = document.querySelectorAll('.tweet-checkbox:checked');
        bulkDeleteBtn.disabled = checkedBoxes.length === 0;
      }

      // Event listener para el checkbox "seleccionar todos"
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
          tweetCheckboxes.forEach(box => {
            box.checked = this.checked;
          });
          updateDeleteButtonState();
        });
      }

      // Event listeners para los checkboxes individuales
      tweetCheckboxes.forEach(box => {
        box.addEventListener('change', updateDeleteButtonState);
      });

      // Botón de seleccionar todos
      if (selectAllButton) {
        selectAllButton.addEventListener('click', function(e) {
          e.preventDefault();
          tweetCheckboxes.forEach(box => {
            box.checked = true;
          });
          if (selectAllCheckbox) selectAllCheckbox.checked = true;
          updateDeleteButtonState();
        });
      }

      // Botón de deseleccionar todos
      if (deselectAllButton) {
        deselectAllButton.addEventListener('click', function(e) {
          e.preventDefault();
          tweetCheckboxes.forEach(box => {
            box.checked = false;
          });
          if (selectAllCheckbox) selectAllCheckbox.checked = false;
          updateDeleteButtonState();
        });
      }

      // Inicialización
      updateDeleteButtonState();
    });
  </script>
{% endblock content %}
